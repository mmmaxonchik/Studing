# Канальный уровень
Канальный уровень решает задачу передачи сообщений по каналам связи с помощью кадров. На канальном уровне определяется: где у потока бит начало сообщения, а где конец сообщения, также определяются ошибки и выполняется коррекция ошибок. Также канал связи решает такие задачи как: Адресация и Согласованный доступ(Если все гаджеты одновременно начнут передавать информацию, то данные в КС искажаются и не смогут быть приняты).

## Что такое кадр?
**Кадр** - это объект состоящий из таких полей как:
+ Заголовок
+ Пакет
+ Концевик

## Как из потока бит выделяются кадры?
Для того чтобы выделить из потока биты, используют такие методы как:
+ Указатель количества байт
+ Вставка байтов
+ Вставка битов
+ Средства физического уровня

## Множественный доступ к каналам
Модель OSI разрабатывалась для каналов связи точка-точка(последовательные линии связи для соединения больших компьютеров), когда были получены разделяемые каналы связи, модель пришлось разделить на:
+ Подуровень управления логическим каналом (LLC) - отвечает за передачу данных(создание кадров, обработка ошибок, итд)
+ Подуровень управления доступом к среде (MAC) - отвечает за использование разделяемой среды, адресацию

## MAC-адреса(Media Access Control)
MAC-адреса используются на канальном уровне, в одноименном подуровне(подуровень управления доступом к среде). Данный подуровень используется когда в сети находятся сразу несколько устройств. Соответственно нам необходимо понять какому устройству передавать данные. Мас-адреса служат для идентификации сетевых интерфейсов узлов сети.
+ Ethernet
+ Wi-fi

**Регламентированы стандартом IEEE802** - длинна адреса составляет 6 байт(48 бит)

**Форма записи** - шесть шестнадцатеричных чисел:
1С:75:08:D2:49:45

**Существует три типа MAC-адресов**:
+ Индивидуальный -  когда мы передаем данные на _индивидуальный_ mac-адрес, то данные получает один компьютер

+ Групповой - когда мы передаем данные на _групповой_ mac-адрес, то данные получают все компьютеры принадлежащие групповому mac-адресу. Первый бит старшего байта равен 1: 01:**:**:**:**:**

+ Широковещательный - когда мы передаем данные на _широковещательный_ mac-адрес, то данные получают все компьютеры в сети. Широковещательный адрес: FF:FF:FF:FF:FF:FF

**В одном сегменте сети MAC-адреса должны быть уникальными**, если два компьютера будут иметь один и тот же MAC-адрес, то один из них не будет работать.

## Технологии канального уровня
+ Ethernet
+ Wi-fi

### Ethernet
**Полезные ссылки**
+ [Что такое Ethernet](https://hpc.by/ethernet)

**Посмотреть позже**:
+ [Не просмотрено](https://youtu.be/s-uDMX4X2jQ)

Ethernet - это самая популярная технология которая позволяет создавать проводные компьютерные сетеи. 

**Типы Ethernet**:
+ Классический
+ + Коллизии
+ + Плохая масштабируемость
+ + Низкая безопасность
+ Коммутируемый
+ + Нет разделяемой среды
+ + Нет коллизий
+ + Новые устройства - коммутаторы(switch) - полносвязая топология, работает на канальном уровне

#### Коммутируемый Ethernet
В коммутируемом Ethernet используется специальное устройство коммутатор(switch), оно имеет полносвязуню топологию и работает на канальном уровне.
Так как коммутатор находится на канальном уровне, он обрабатывает кадры извлекая от туда адрес отправителя и получателя, далее он передает данные на тот порт к которому подключен адрес получателя.

<br><img src="https://www.d-link-shop.ru/thumbs/resize/380x425/uploads/products/5460_1.jpg" height="300">

**Особенности работы коммутаторов**:
+ Таблица коммутации
+ Алгоритм обратного обучения
+ Алгоритм прозрачного моста

**Таблица коммутации**:
Таблица коммутации в простом случае состоит из двух столбцов:
1. Порт коммутатора
2. MAC-адрес 

**Алгоритм обратного обучения**:
Для того чтобы заполнить таблицу MAC-адресами, коммутатор принимает отправленные кадры и извлекает из них адрес отправителя, далее этот адрес ставится в соответствие с портом.

**Алгоритм прозрачного моста**
Мост - это устройство для объединения нескольких сетей, для коммутаторов был выбран прозрачный мост, который имеет свои особенности:
+ Он не заметен для сетевых устройств, т.е. не имеет собственного MAC адреса
+ Не требует настройки

#### Классический Ethernet
Для передачи данных по технологии Ethernet используются кадры. У технологии есть два современных поддерживаемый стандарта:
+ Ethernet II - используется чаще
+ IEEE 802.3

Формат кадра Ethernet II:
+ Заголовок
+ + Адрес получателя - 6 байт
+ + Адрес отправителя - 6 байт
+ + Тип - 2 байта - в данном поле содержится код протокола от которого получены данные
+ + + IPv4 - 0800
+ + + IPv6 - 86DD
+ + + ARP - 0806
+ Данные - 46-1500 байт
+ Концевик(Контрольная сумма) - 4 байта

Физический уровень:
+ Коаксиальный кабель
<br><img src="https://www.ferra.ru/imgs/2018/11/26/16/2584281/8242b84e7ec3355a2040b31cf6af3abe593eda81.jpg" width="300" height="300">

+ Витая пара
<br><img src="https://anlan.ru/files/uploads/ethernet-cable-yellow.jpg" width="300" height="300">

+ Оптоволокно
<br><img src="https://set-os.ru/wp-content/uploads/2014/08/optovolokno-03.jpg" width="300" height="300">

Канальный уровень:
+ Методы доступа и протоколы, одинаковы для любой среды
+ В классическом Ethernet смешаны уровни LLC и MAC


#### VLAN(Virtual Local Area Network)
VLAN - это технология разделения единой сети на несколько логических сетей изолированных друг от друга. Технология VLAN реализуется коммутаторами на канальном уровне.

**Преимуществом использования VLAN является изоляция сети**, например можно сделать разделение для разных отделов внутри компании или сделать разделение для компаний в бизнес-центре. **Преимуществом изоляции сети является:**
+ Безопасность
+ Распределение нагрузки
+ Ограничение широковещательного трафика

В таблице коммутации есть отдельное поле VLAN, оно помечено определенным числом.

Стандарт кадра IEEE 802.1Q включает в себя два новых поля по 2 байта:
+ Тэг - содержит номер VLAN
+ Тип - содержит 0x8100 если кадр передается с VLAN

#### Протокол STP
Протокол STP или протокол связующего дерева необходим для предотвращения кольцевой зависимости в коммутаторах. Данный протокол предоставляет автоматическое отключение дублирующего соединения в Ethernet. Название протокола обозначает подграф без циклов, содержащий все вершины исходного графа. Протокол отвечает стандарту IEEE 802.1D и находится на канальном уровне.

**Преимущества**:
+ Надежность соединений между коммутаторами
+ Защита от ошибок конфигурации

**Как работает протокол?**
Если у подключенных коммутаторов будет циклическая зависимость, то одно из соединений будет отключено на программном уровне. Кабель будет подключен, но данные не будут передаваться от одного коммутатора к другому. В случае если соединение среди коммутаторов будет разорвано, то отключенное соединение вновь будет подключено.



### Wi-Fi
Wi-Fi - это технология беспроводных локальных сетей. Стандарт IEEE 802.1. Данная технология располагается на канальном и физическом уровне, на канальном уровне она охватывает два подуровня:
+ Подуровень правления логическим каналом (LLC)
+ Подуровень управления доступом к среде (MAC)

> Технология Wi-Fi похожа на Ethernet, так как имеет адресацию по MAC-адресам, только вот у Ethernet разделяемая среда - кабель, а у Wi-Fi - радиоэфир. 

**Формат кадра Wi-Fi уровня MAC**:
+ Управление кадром - 2 байта
+ + Версия протокола - на данный момент используется версия 0
+ + Тип - тип кадра **в Wi-Fi используется три типа кадров**
+ + + Кадры данных
+ + + Кадры контроля - Служебные кадры, RTS, CTS, ACK 
+ + + Кадры управления - Реализация сервисов Wi-fi 
+ + Подтип - подтип кадра  
+ + To Ds - указывает что кадр передан к проводной сети(To Destitution System)
+ + From Ds - указывает что кадр передан от проводной сети(From Destitution System)
+ + MF - если ошибки при передаче встречаются на каждые 1000 байт, то кадры будут разбиваться на фрагменты, данное поле отвечает за флаг, который означает будут ли еще фрагменты или нет
+ + RT - флаг RT говорит нам о необходимости повторной отправки, в случае если отправитель не получил подтверждении о принятии кадров
+ + Power Mgmt - флаг управления питанием
+ + MD - флаг устанавливается когда станция работает в режиме сохранения питания, и есть еще данные (More Data)
+ + Protection Frame - флаг показывает используется шифрование данных или нет
+ + Order - флаг устанавливается если порядок сообщения сохраняется
+ Длительность - 2 байта - указывается на какое время зарезервирован канал доступа передачи Wi-Fi
+ Адрес 1 - 6 байт
+ Адрес 2 - 6 байт
+ Адрес 3 - 6 байт
+ Управление очередностью - 2 байта
+ + Номер последовательности - используется для того чтобы указать номер последовательности фрагментов, при разбиении кадра на фрагменты 
+ + Номер фрагмента - номер фрагмента при разбиении
+ Адрес 4 - 6 байт
+ Тело кадра - 0-2304 байт
+ Контрольная сумма - 4 байта

> Почему у Wi-Fi 4 адреса, а не 2 как у Ethernet? Wi-Fi чаще всего используется в инфраструктурном режиме(данные из беспроводной сети передаются в проводную сеть для последующей передачи в интернет, или в другую неизвестную для нас сеть), чаще всего в таком режиме мы имеем 3 устройства - компьютер, точка доступа, устройство в проводной сети. В Wi-Fi адреса называются следующим образом: 
> + DA - Destination address - адрес получателя
> + SD - Source address - адрес отправителя
> + RA - Receiver address - адрес устройства которое получает данные из беспроводной сети 
> + TA - Transmitter address - адрес устройства которое отправляет данные в беспроводную сеть

При передаче кадра от компьютера к точке доступа и далее к маршрутизатору адреса будут распределятся так:
+ Адрес 1 - RA - MAC-адрес точки доступа
+ Адрес 2 - TA/SA - Mac-адрес нашего компьютера
+ Адрес 3 - DA - Mac-адрес проводного устройства - маршрутизатора

При передаче кадра от проводного устройства к точке доступа и далее к компьютеру адреса будут распределятся так:
+ Адрес 1 - RA/DA - Mac-адрес нашего компьютера
+ Адрес 2 - ТА - Mac-адрес точки доступа
+ Адрес 3 - SA - Mac-адрес проводного устройства - маршрутизатора

**Основные сервисы Wi-Fi**
+ Ассоциация
+ Аутентификация
+ Передача данных
+ Защита информации
+ и др...
 
Wi-Fi предоставляет два набора сервисов - базовый и расширенный.

В случае **базового набора** сервисов мы имеем одну точку доступа, которая может использоваться сама по себе или может быть подключена к распределительной системе. В своем радиусе действия точка доступа рассылает идентификаторы набора своего сервиса - BSSID(
Basic Service Set Identifier): Mac-адрес точки доступа, кроме этого рассылается SSID(Service Set Identifier): понятный для людей идентификатор точки доступа. 

В случае **расширенного набора** сервисов мы имеем две и более точек доступа, которые имеют одинаковый SSID. Расширенный набор сервисов позволяет быстрый переход из одной зоны действия точки доступа в другую без повторной аутентификации за счет использовании контроллера.

**Первым шагом** использования Wi-Fi является _аутентификация_, для этого клиент высылает кадр 
управления специального вида - Management Frame, если точку доступа удовлетворил данный кадр, то она в ответ высылает кадр подтверждения. 
 
**Режимы аутентификации:**
+ Открытая, подключение без пароля
+ Personal - единый пароль для всех устройств
+ Enterspire - отдельные пароли для разных пользователей

**Вторым шагом** использования Wi-Fi является _ассоциация_, после аутентификации пользователь высылает точке доступа запрос на ассоциацию, в этом запросе клиент передает параметры Wi-Fi с которыми он может работать, если точка доступа принимает эти параметры то она высылает кадр с успешной ассоциацией.

**Шифрование** - в технологии Wi-Fi есть три типа шифрования:
+ WEP 
+ WPA
+ WPA2

> Шифруются только данные, но не заголовки